# GitLab CI/CD 配置文件 - Nuxt.js 静态站点增量部署
# 优化策略：依赖缓存 + 增量构建 + PowerShell 原生 FTP 增量部署

# ============================================
# 全局配置
# ============================================
variables:
  # Git 配置（保留现有设置）
  GIT_CONFIG_COUNT: "1"
  GIT_CONFIG_KEY_0: "http.version"
  GIT_CONFIG_VALUE_0: "HTTP/1.1"
  GIT_SSL_NO_VERIFY: "true"

  # FTP 部署配置
  FTP_REMOTE_PATH: "/aib"

  # Node 版本（可选）
  NODE_VERSION: "18"

# ============================================
# Pipeline 阶段划分
# ============================================
stages:
  - setup # 依赖安装和缓存
  - build # 构建静态站点
  - deploy # 增量部署到 FTP

# ============================================
# Stage 1: Setup - 依赖缓存优化
# ============================================
setup:dependencies:
  stage: setup
  tags:
    - windows

  # 缓存配置：基于 yarn.lock 生成缓存键
  cache:
    key:
      files:
        - yarn.lock # 当 yarn.lock 变化时，缓存失效
    paths:
      - node_modules/
    policy: pull-push # 拉取并更新缓存

  script:
    # 检查缓存是否有效，智能决定安装策略
    - |
      if (Test-Path node_modules/.bin) {
        Write-Host "✓ Using cached dependencies"
        # 使用缓存时，快速校验依赖完整性
        yarn install --frozen-lockfile --prefer-offline --check-files
      } else {
        Write-Host "✓ Installing dependencies from scratch"
        # 首次安装或缓存失效时，完整安装
        yarn install --frozen-lockfile
      }

    # 显示依赖安装统计
    - |
      Write-Host ""
      Write-Host "Node modules size:"
      if (Test-Path node_modules) {
        $size = (Get-ChildItem node_modules -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "$([math]::Round($size, 2)) MB"
      }

  # 不使用 artifacts，通过 cache 共享（避免体积过大）
  # artifacts:
  #   expire_in: 1h
  #   paths:
  #     - node_modules/

# ============================================
# Stage 2: Build - 构建优化
# ============================================
build:nuxt:
  stage: build
  tags:
    - windows

  # 依赖 setup job（通过 cache 获取 node_modules）
  needs:
    - setup:dependencies

  # 仅拉取缓存，不更新（节省时间）
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
    policy: pull

  script:
    # 构建前验证：确保 node_modules 存在（通过 cache 恢复）
    - |
      if (!(Test-Path node_modules/.bin)) {
        Write-Error "node_modules not found! Cache may not have been restored correctly."
        exit 1
      }

    # 执行 Nuxt 静态站点生成
    - |
      Write-Host "Starting Nuxt.js static site generation..."
      yarn generate

    # 构建后验证：确保构建产物存在
    - |
      if (!(Test-Path .output/public)) {
        Write-Error ".output/public missing after build!"
        exit 1
      }

    # 重命名为 website（保持与现有流程一致）
    - |
      if (Test-Path website) {
        Remove-Item website -Recurse -Force
      }
      Move-Item .output/public website

    # 显示构建产物信息
    - |
      Write-Host ""
      Write-Host "================================================"
      Write-Host "Build artifacts summary:"
      Write-Host "================================================"
      $fileCount = (Get-ChildItem website -Recurse -File | Measure-Object).Count
      $dirCount = (Get-ChildItem website -Recurse -Directory | Measure-Object).Count
      $totalSize = (Get-ChildItem website -Recurse -File | Measure-Object -Property Length -Sum).Sum / 1MB
      Write-Host "Files: $fileCount"
      Write-Host "Directories: $dirCount"
      Write-Host "Total size: $([math]::Round($totalSize, 2)) MB"
      Write-Host "================================================"

  # 构建产物缓存配置（用于 deploy job）
  cache:
    - key:
        files:
          - yarn.lock
      paths:
        - node_modules/
      policy: pull
    - key: build-$CI_COMMIT_REF_SLUG
      paths:
        - website/
      policy: push

  # 仅在相关文件变化时触发构建
  only:
    changes:
      - "**/*.vue"
      - "**/*.js"
      - "**/*.ts"
      - "**/*.css"
      - "nuxt.config.js"
      - "package.json"
      - "yarn.lock"

# ============================================
# Stage 3: Deploy - 增量部署
# ============================================
deploy:ftp:
  stage: deploy
  tags:
    - windows

  # 依赖 build job（通过 cache 获取 website/）
  needs:
    - build:nuxt

  # 从 cache 恢复构建产物
  cache:
    key: build-$CI_COMMIT_REF_SLUG
    paths:
      - website/
    policy: pull

  before_script:
    # 环境变量验证：确保所有必需的 FTP 凭证已配置
    - |
      if (-not $env:FTP_HOST -or -not $env:FTP_USER -or -not $env:FTP_PASS) {
        Write-Error "Missing required FTP environment variables!"
        Write-Error "Please configure in GitLab CI/CD Settings > Variables:"
        Write-Error "  - FTP_HOST"
        Write-Error "  - FTP_USER"
        Write-Error "  - FTP_PASS (mark as Protected)"
        exit 1
      }

    # 验证 PowerShell 版本（需要 5.1+）
    - |
      $psVersion = $PSVersionTable.PSVersion
      Write-Host "PowerShell version: $psVersion"
      if ($psVersion.Major -lt 5) {
        Write-Error "PowerShell 5.1 or higher is required"
        Write-Error "Current version: $psVersion"
        Write-Error "Please upgrade PowerShell on the GitLab Runner"
        exit 1
      }
      Write-Host "✓ PowerShell version is compatible"

  script:
    # 部署前验证：确保构建产物存在（通过 cache 恢复）
    - |
      if (!(Test-Path website)) {
        Write-Error "website/ directory not found! Cache may not have been restored correctly."
        exit 1
      }
    
    # 调用外部 PowerShell 脚本进行增量部署
    - .\scripts\deploy-ftp-incremental.ps1

  # 仅在 main 分支触发部署
  only:
    - main

  # 仅在构建成功后执行
  when: on_success

  # 环境配置
  environment:
    name: production
    url: https://aib.hujiarong.site

# ============================================
# 可选：部署验证和性能监控
# ============================================
validate:deployment:
  stage: deploy
  tags:
    - windows

  needs:
    - deploy:ftp

  script:
    # 验证站点可访问性
    - |
      Write-Host "Validating deployment..."
      try {
        $response = Invoke-WebRequest -Uri "https://aib.hujiarong.site" -Method Head -TimeoutSec 10
        if ($response.StatusCode -eq 200) {
          Write-Host "✓ Site is accessible (HTTP $($response.StatusCode))"
        } else {
          Write-Warning "Site returned unexpected status code: $($response.StatusCode)"
        }
      }
      catch {
        Write-Warning "Failed to validate deployment: $($_.Exception.Message)"
        Write-Host "This may be normal if the site URL is not configured yet."
      }

  only:
    - main

  # 手动触发
  when: manual

  # 允许失败（验证失败不影响部署状态）
  allow_failure: true
