variables:
  GIT_CONFIG_COUNT: "1"
  GIT_CONFIG_KEY_0: "http.version"
  GIT_CONFIG_VALUE_0: "HTTP/1.1"
  GIT_SSL_NO_VERIFY: "true"

stages: [build, deploy]

build-job:
  stage: build
  tags: [windows]
  script:
    - yarn install
    - yarn generate
    - if (!(Test-Path .output/public)) { Write-Host "[ERROR] .output/public missing"; exit 1 }
    - if (Test-Path website) { Remove-Item website -Recurse -Force }
    - Move-Item .output/public website
    - if (!(Test-Path website)) { Write-Host "[ERROR] website creation failed"; exit 1 }
  artifacts:
    paths: [website/]
    expire_in: 1 hour

deploy-job:
  stage: deploy
  tags: [windows]
  before_script:
    - |
      if (-not $env:FTP_HOST -or -not $env:FTP_USER -or -not $env:FTP_PASS) {
        Write-Error "Missing required FTP environment variables"
        exit 1
      }
  script:
    - |  
      function Add-FtpFile {  
        param($ftpFilePath, $localFile, $username, $password) {  
          try {
            Write-Host "Uploading: $localFile to $ftpFilePath"
            $ftprequest = [System.Net.FtpWebRequest]::Create($ftpFilePath)  
            $ftprequest.Credentials = New-Object System.Net.NetworkCredential($username, $password)  
            $ftprequest.Method = [System.Net.WebRequestMethods+Ftp]::UploadFile  
            $content = [System.IO.File]::ReadAllBytes($localFile)  
            $ftprequest.ContentLength = $content.Length  
            $rs = $ftprequest.GetRequestStream()  
            $rs.Write($content, 0, $content.Length)  
            $rs.Close()  
            $rs.Dispose()
            Write-Host "Successfully uploaded: $ftpFilePath"
          }
          catch {
            Write-Error "Failed to upload $localFile : $_"
            exit 1
          }
        }  
      }  

      function Add-FtpDirectory {  
        param($ftpPath, $username, $password) {  
          try {
            Write-Host "Creating directory: $ftpPath"
            $ftprequest = [System.Net.FtpWebRequest]::Create($ftpPath)  
            $ftprequest.Credentials = New-Object System.Net.NetworkCredential($username, $password)  
            $ftprequest.Method = [System.Net.WebRequestMethods+Ftp]::MakeDirectory  
            $response = $ftprequest.GetResponse()
            $response.Close()
            Write-Host "Successfully created directory: $ftpPath"
          } catch {
            # Directory already exists or other error
            Write-Host "Directory creation status: $ftpPath - $_"
          }
        }  
      }  

      function Add-FtpFolderWithFiles {  
        param($sourceFolder, $destinationFolder, $username, $password) {  
          Write-Host "Processing folder: $sourceFolder"
          Add-FtpDirectory $destinationFolder $username $password  
          $files = Get-ChildItem $sourceFolder -File  
          foreach($file in $files) {  
            $uploadUrl = "$destinationFolder/$($file.Name)"  
            Add-FtpFile $uploadUrl $file.FullName $username $password  
          }  
        }  
      }  

      function Add-FtpFolderWithFilesRecursive {  
        param($sourceFolder, $destinationFolder, $username, $password) {  
          Write-Host "Starting recursive upload from: $sourceFolder"
          Add-FtpFolderWithFiles $sourceFolder $destinationFolder $username $password  
          $subDirs = Get-ChildItem $sourceFolder -Directory  
          foreach($subDir in $subDirs) {  
            $destPath = "$destinationFolder/$($subDir.Name)"
            Add-FtpFolderWithFilesRecursive $subDir.FullName $destPath $username $password  
          }  
        }  
      }  

      $ftpUri = "ftp://$env:FTP_HOST/aib"
      Write-Host "Starting FTP upload to: $ftpUri"
      Add-FtpFolderWithFilesRecursive "website/" $ftpUri $env:FTP_USER $env:FTP_PASS
      Write-Host "FTP upload completed"
